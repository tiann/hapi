# HAPI Hub Go é‡æ„è®¡åˆ’

> ç‰ˆæœ¬: v1.0.0
> çŠ¶æ€: è§„åˆ’ä¸­
> é¢„ä¼°å·¥æœŸ: 7 å‘¨

## ç›®å½•

- [1. é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
- [2. èƒŒæ™¯ä¸åŠ¨æœº](#2-èƒŒæ™¯ä¸åŠ¨æœº)
- [3. æ¶æ„è®¾è®¡](#3-æ¶æ„è®¾è®¡)
- [4. é˜¶æ®µè§„åˆ’](#4-é˜¶æ®µè§„åˆ’)
- [5. æŠ€æœ¯å†³ç­–](#5-æŠ€æœ¯å†³ç­–)
- [6. æ–‡ä»¶ç»“æ„](#6-æ–‡ä»¶ç»“æ„)
- [7. ä¾èµ–æ¸…å•](#7-ä¾èµ–æ¸…å•)
- [8. é‡Œç¨‹ç¢‘](#8-é‡Œç¨‹ç¢‘)
- [9. é£é™©ä¸ç¼“è§£](#9-é£é™©ä¸ç¼“è§£)
- [10. å…¼å®¹æ€§ä¿éšœ](#10-å…¼å®¹æ€§ä¿éšœ)
- [11. æ€§èƒ½ç›®æ ‡](#11-æ€§èƒ½ç›®æ ‡)
- [12. è¿ç§»æ­¥éª¤ä¸åˆ‡æ¢æµç¨‹](#12-è¿ç§»æ­¥éª¤ä¸åˆ‡æ¢æµç¨‹)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 å½“å‰æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯æ ˆ | ä»£ç é‡ |
|------|--------|--------|
| Hub æœåŠ¡å™¨ | Bun + Hono + Socket.IO | ~30,000 è¡Œ |
| CLI é›†æˆ | Bun + React Ink | ~25,000 è¡Œ |
| Web å‰ç«¯ | React + Vite | ~20,000 è¡Œ |
| å…±äº«ç±»å‹ | TypeScript + Zod | ~4,000 è¡Œ |

**æ€»è®¡**: ~58,000 è¡Œä»£ç 

### 1.2 ç›®æ ‡æŠ€æœ¯æ ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç›®æ ‡æ¶æ„                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚   Go Hub   â”‚   â”‚   Bun CLI   â”‚   â”‚  React Web  â”‚       â”‚
â”‚   â”‚  (é‡æ„)    â”‚   â”‚   (ä¿ç•™)    â”‚   â”‚    (ä¿ç•™)   â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚          â”‚                  â”‚                  â”‚            â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                             â”‚                               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                    â”‚  SQLite (å…±äº«)  â”‚                       â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 é‡æ„èŒƒå›´

| éƒ¨åˆ† | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Hub æœåŠ¡å™¨ | ğŸ”„ é‡æ„ | ç”¨ Go é‡å†™ HTTP/Socket.IO/SSE å±‚ï¼ˆä¿æŒåè®®/å¥‘çº¦ä¸å˜ï¼‰ |
| CLI | â³ ä¿æŒå…¼å®¹ | ä¿æŒ Bunï¼Œç»§ç»­ä½¿ç”¨ Socket.IO |
| Web | â³ ä¿æŒå…¼å®¹ | ä¿æŒ Reactï¼Œé€šè¿‡ Hub API é€šä¿¡ |
| æ•°æ®åº“ | â³ å…±äº« | ç›´æ¥ä½¿ç”¨ç°æœ‰ SQLite æ–‡ä»¶ï¼ˆä¿æŒ schema å…¼å®¹ï¼Œä¸å¼•å…¥ç ´åæ€§è¿ç§»ï¼‰ |

---

## 2. èƒŒæ™¯ä¸åŠ¨æœº

### 2.1 æ€§èƒ½ç“¶é¢ˆåˆ†æ

è¯¦è§ [æ€§èƒ½ç“¶é¢ˆåˆ†ææŠ¥å‘Š](./PERFORMANCE_ANALYSIS.md)

| ä¼˜å…ˆçº§ | ç“¶é¢ˆ | ä½ç½® | å½±å“ |
|--------|------|------|------|
| ğŸ”´ é«˜ | SSE heartbeat ä¸²è¡Œ | `sseManager.ts:127` | å¤§è¿æ¥æ•°æ—¶é˜»å¡äº‹ä»¶å¾ªç¯ |
| ğŸ”´ é«˜ | broadcast æ— èƒŒå‹ | `sseManager.ts:107` | å¿«é€Ÿäº‹ä»¶å‹å®æ…¢é€Ÿå®¢æˆ·ç«¯ |
| ğŸ”´ é«˜ | N+1 æ•°æ®åº“æŸ¥è¯¢ | `sessionCache.ts:131` | 100+ ä¼šè¯æ—¶æ€§èƒ½ä¸‹é™ |
| ğŸ”´ é«˜ | æ¶ˆæ¯é˜Ÿåˆ—é‡å¤æ’åº | `OutgoingMessageQueue.ts:111` | O(n log n) é‡å¤å¼€é”€ |
| ğŸŸ¡ ä¸­ | Todo å›å¡«æŸ¥è¯¢ | `sessionCache.ts:75` | é¦–æ¬¡åŠ è½½è§¦å‘é¢å¤–æŸ¥è¯¢ |
| ğŸŸ¡ ä¸­ | RPC JSON åºåˆ—åŒ– | `rpcGateway.ts:215` | é‡å¤åºåˆ—åŒ–å¼€é”€ |

### 2.2 Go ä¼˜åŠ¿

| ç‰¹æ€§ | Bun/Node.js | Go |
|------|-------------|-----|
| å¹¶å‘æ¨¡å‹ | äº‹ä»¶å¾ªç¯ + async/await | goroutine + channel |
| ç¼–è¯‘ | è§£é‡Šå‹/ JIT | åŸç”Ÿç¼–è¯‘ |
| å†…å­˜ç®¡ç† | GC | ç²¾ç¡® GC |
| å•æ–‡ä»¶éƒ¨ç½² | éœ€è¦ Node.js | è‡ªåŒ…å«äºŒè¿›åˆ¶ |
| WebSocket | Socket.IO (å¼€é”€å¤§) | Socket.IO åè®®å…¼å®¹å®ç°ï¼ˆGoï¼‰ |
| æ€§èƒ½åŸºå‡† | å¿« | æ›´å¿« (2-5x) |

---

## 3. æ¶æ„è®¾è®¡

### 3.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           HAPI Hub Go æ¶æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                        å®¢æˆ·ç«¯å±‚                                   â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚   â”‚  â”‚   CLI    â”‚  â”‚   Web    â”‚  â”‚ Telegram â”‚  â”‚   PWA    â”‚         â”‚    â”‚
â”‚   â”‚  â”‚(Bun)    â”‚  â”‚(React)  â”‚  â”‚   Bot    â”‚  â”‚          â”‚         â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚   â”‚       â”‚ Socket.IO â”‚    â”‚   SSE    â”‚    â”‚   API    â”‚    â”‚  API     â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚           â”‚    â”‚          â”‚    â”‚          â”‚                   â”‚
â”‚           â–¼           â–¼    â–¼          â–¼    â–¼          â–¼                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                     Go Hub Server                                 â”‚    â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚   â”‚  â”‚   HTTP   â”‚  â”‚ Socket.IO â”‚  â”‚   SSE    â”‚  â”‚   Bot    â”‚         â”‚    â”‚
â”‚   â”‚  â”‚  Server  â”‚  â”‚  Server   â”‚  â”‚  Server  â”‚  â”‚ Handler  â”‚         â”‚    â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚   â”‚       â”‚           â”‚    â”‚          â”‚    â”‚          â”‚                   â”‚
â”‚   â”‚       â–¼           â–¼    â–¼          â–¼    â–¼          â–¼                   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â”‚                     Core Layer                                   â”‚  â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚
â”‚   â”‚  â”‚  â”‚   Sync   â”‚  â”‚ Session  â”‚  â”‚Machine   â”‚  â”‚Message   â”‚         â”‚  â”‚
â”‚   â”‚  â”‚  â”‚  Engine  â”‚  â”‚  Cache   â”‚  â”‚  Cache   â”‚  â”‚ Service  â”‚         â”‚  â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚  â”‚
â”‚   â”‚  â”‚  â”‚   RPC    â”‚  â”‚   Event  â”‚  â”‚ Notifica-â”‚                       â”‚  â”‚
â”‚   â”‚  â”‚  â”‚ Gateway  â”‚  â”‚Publisher â”‚  â”‚   tion   â”‚                       â”‚  â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   Hub    â”‚                       â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   â”‚                                    â”‚                                  â”‚
â”‚   â”‚                                    â–¼                                  â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  â”‚                     Data Layer                                   â”‚  â”‚
â”‚   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚  â”‚
â”‚   â”‚  â”‚  â”‚ SQLite   â”‚  â”‚   JWT    â”‚  â”‚   Config â”‚  â”‚  Tunnel  â”‚         â”‚  â”‚
â”‚   â”‚  â”‚  â”‚   (WAL)  â”‚  â”‚  Token   â”‚  â”‚  Store   â”‚  â”‚ Manager  â”‚         â”‚  â”‚
â”‚   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚   â”‚                                                                          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ç»„ä»¶å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç»„ä»¶ä¾èµ–å…³ç³»                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                    â”‚   http.Server   â”‚                                   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                             â”‚                                            â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚              â”‚              â”‚              â”‚                             â”‚
â”‚              â–¼              â–¼              â–¼                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚    â”‚ http.Routes â”‚  â”‚socketio.Serverâ”‚  â”‚sse.Server   â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚           â”‚                â”‚                â”‚                             â”‚
â”‚           â”‚                â”‚                â”‚                             â”‚
â”‚           â–¼                â–¼                â–¼                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚    â”‚                    sync.Engine                                  â”‚    â”‚
â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚    â”‚
â”‚    â”‚  â”‚Session  â”‚ â”‚Machine  â”‚ â”‚ Message â”‚ â”‚  RPC    â”‚               â”‚    â”‚
â”‚    â”‚  â”‚ Cache   â”‚ â”‚ Cache   â”‚ â”‚Service  â”‚ â”‚Gateway  â”‚               â”‚    â”‚
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚                                            â”‚
â”‚                             â–¼                                            â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                    â”‚    store.DB     â”‚                                   â”‚
â”‚                    â”‚   (SQLite WAL)  â”‚                                   â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                         å¤–éƒ¨æœåŠ¡                                    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚  â”‚  â”‚ Telegram  â”‚  â”‚ Web Push  â”‚  â”‚  tunwg    â”‚  â”‚  CLI      â”‚       â”‚  â”‚
â”‚  â”‚  â”‚    API    â”‚  â”‚   API     â”‚  â”‚  Tunnel   â”‚  â”‚(Bun)     â”‚       â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. é˜¶æ®µè§„åˆ’

### é˜¶æ®µé›¶ï¼šå¥‘çº¦å†»ç»“ (Week 0)

**ç›®æ ‡**: å†»ç»“ç°æœ‰ Bun Hub è¡Œä¸ºä½œä¸ºè¿ç§»åŸºçº¿

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æè¿° | çŠ¶æ€ | é¢„ä¼°å·¥æ—¶ |
|------|------|------|----------|
| 4.0.1 | ç”Ÿæˆå¥‘çº¦åŸºçº¿æ–‡æ¡£ï¼ˆHTTP/Socket/SSE/é”™è¯¯ä½“ï¼‰ | â³ | 8h |
| 4.0.2 | æäº¤å¥‘çº¦åŸºçº¿æ–‡ä»¶ï¼ˆhub_go/test/contractsï¼‰ | â³ | 4h |
| 4.0.3 | å†»ç»“å­—æ®µä¸è¡Œä¸ºï¼Œè¿›å…¥å˜æ›´å®¡æŸ¥æµç¨‹ | â³ | 2h |

#### é˜¶æ®µäº§å‡º

- `docs/refactor/HUB_CONTRACT_BASELINE.md`
- `hub_go/test/contracts/*`

### é˜¶æ®µä¸€ï¼šåŸºç¡€è®¾æ–½å±‚ (Week 1)

**ç›®æ ‡**: å»ºç«‹ Go é¡¹ç›®åŸºç¡€æ¡†æ¶å’Œæ•°æ®åº“å±‚

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æè¿° | çŠ¶æ€ | é¢„ä¼°å·¥æ—¶ |
|------|------|------|----------|
| 4.1.1 | åˆ›å»º Go module (`go.mod`) | â³ | 1h |
| 4.1.2 | é…ç½® Makefile æ„å»ºè„šæœ¬ | â³ | 1h |
| 4.1.3 | é…ç½®å¼€å‘ç¯å¢ƒ (docker-compose) | â³ | 2h |
| 4.1.4 | å®ç° SQLite è¿æ¥æ±  (WAL æ¨¡å¼) | â³ | 4h |
| 4.1.5 | å®ç° Store æ¥å£æŠ½è±¡ | â³ | 4h |
| 4.1.6 | å†»ç»“ç°æœ‰æ•°æ®åº“ schemaï¼ˆä»…æ–°å¢å‘å‰å…¼å®¹è¿ç§»ï¼‰ | â³ | 4h |
| 4.1.7 | å®ç° sessions CRUD | â³ | 4h |
| 4.1.8 | å®ç° machines CRUD | â³ | 4h |
| 4.1.9 | å®ç° messages CRUD | â³ | 4h |
| 4.1.10 | å®ç° users CRUD | â³ | 2h |
| 4.1.11 | å®ç° push_subscriptions CRUD | â³ | 2h |
| 4.1.12 | **ä¿®å¤ N+1 æŸ¥è¯¢é—®é¢˜** | â³ | 4h |

#### é˜¶æ®µäº§å‡º

```
$ tree internal/store
internal/store/
â”œâ”€â”€ db.go              # è¿æ¥æ± å’Œåˆå§‹åŒ–
â”œâ”€â”€ sessions.go        # ä¼šè¯å­˜å‚¨
â”œâ”€â”€ machines.go        # æœºå™¨å­˜å‚¨
â”œâ”€â”€ messages.go        # æ¶ˆæ¯å­˜å‚¨
â”œâ”€â”€ users.go           # ç”¨æˆ·å­˜å‚¨
â””â”€â”€ push.go            # æ¨é€è®¢é˜…å­˜å‚¨
```

#### å…³é”®æŠ€æœ¯ç‚¹

```go
// internal/store/db.go

package store

import (
  "database/sql"
  _ "github.com/mattn/go-sqlite3"
)

type DB struct {
  *sql.DB
  // ... ç‰¹å®šæŸ¥è¯¢æ–¹æ³•
}

func NewDB(path string) (*DB, error) {
  db, err := sql.Open("sqlite3", path)
  if err != nil {
    return nil, err
  }

  // WAL æ¨¡å¼
  db.Exec("PRAGMA journal_mode=WAL")
  db.Exec("PRAGMA synchronous=NORMAL")
  db.Exec("PRAGMA cache_size=-64000")  // 64MB
  db.Exec("PRAGMA foreign_keys=ON")

  return &DB{DB: db}, nil
}

// æ‰¹é‡æŸ¥è¯¢ç¤ºä¾‹ (ä¿®å¤ N+1)
func (db *DB) GetSessionsByIDs(ids []string) ([]StoredSession, error) {
  if len(ids) == 0 {
    return nil, nil
  }

  // å•æ¬¡æŸ¥è¯¢ + IN clause
  query := `SELECT * FROM sessions WHERE id IN (` + placeholders(ids) + `)`
  rows, err := db.Query(query, toInterfaces(ids)...)
  // ...
}
```

---

### é˜¶æ®µäºŒï¼šæ ¸å¿ƒåŒæ­¥å¼•æ“ (Week 2)

**ç›®æ ‡**: å®ç°å†…å­˜ç¼“å­˜å’Œäº‹ä»¶ç³»ç»Ÿ

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æè¿° | çŠ¶æ€ | é¢„ä¼°å·¥æ—¶ |
|------|------|------|----------|
| 4.2.1 | å®ç° SyncEngine ä¸»ç»“æ„ | â³ | 4h |
| 4.2.2 | å®ç° SessionCache (å¸¦æ‰¹é‡åŠ è½½) | â³ | 8h |
| 4.2.3 | å®ç° MachineCache | â³ | 4h |
| 4.2.4 | å®ç° MessageService | â³ | 4h |
| 4.2.5 | å®ç° RpcGatewayï¼ˆä¿æŒ JSON ç»“æ„ä¸ç°æœ‰å­—æ®µï¼‰ | â³ | 8h |
| 4.2.6 | å®šä¹‰ SyncEvent ç±»å‹ | â³ | 2h |
| 4.2.7 | å®ç° EventPublisher (channel èƒŒå‹) | â³ | 4h |
| 4.2.8 | å®ç° EventSubscriber | â³ | 2h |

#### é˜¶æ®µäº§å‡º

```
$ tree internal/sync
internal/sync/
â”œâ”€â”€ engine.go           # æ ¸å¿ƒå¼•æ“
â”œâ”€â”€ session_cache.go   # ä¼šè¯ç¼“å­˜
â”œâ”€â”€ machine_cache.go   # æœºå™¨ç¼“å­˜
â”œâ”€â”€ message_service.go # æ¶ˆæ¯æœåŠ¡
â”œâ”€â”€ rpc_gateway.go     # RPC ç½‘å…³
â””â”€â”€ event.go           # äº‹ä»¶ç±»å‹
```

#### å…³é”®æŠ€æœ¯ç‚¹

```go
// internal/sync/session_cache.go

package sync

import (
  "sync"
  "time"
)

type SessionCache struct {
  mu        sync.RWMutex
  sessions  map[string]*CachedSession
  store     *store.DB
  bulkLoad  bool  // æ‰¹é‡åŠ è½½æ ‡å¿—
}

type CachedSession struct {
  Data       StoredSession
  UpdatedAt  time.Time
  AccessAt   time.Time
}

const (
  maxSessions = 1000
  sessionTTL  = 15 * time.Minute
)

func (c *SessionCache) Get(id string) (*StoredSession, error) {
  c.mu.RLock()
  sess, ok := c.sessions[id]
  c.mu.RUnlock()

  if !ok {
    // å•æ¡åŠ è½½
    return c.loadOne(id)
  }

  // æ›´æ–°è®¿é—®æ—¶é—´
  sess.AccessAt = time.Now()
  return &sess.Data, nil
}

func (c *SessionCache) GetAll(ids []string) ([]StoredSession, error) {
  // æ‰¹é‡åŠ è½½ (ä¿®å¤ N+1)
  return c.store.GetSessionsByIDs(ids)
}
```

```go
// internal/sync/event.go

package sync

// SyncEventType å®šä¹‰äº‹ä»¶ç±»å‹
type SyncEventType string

const (
  EventSessionAdded    SyncEventType = "session-added"
  EventSessionUpdated  SyncEventType = "session-updated"
  EventSessionRemoved  SyncEventType = "session-removed"
  EventMessageReceived SyncEventType = "message-received"
  EventMachineUpdated  SyncEventType = "machine-updated"
  EventToast          SyncEventType = "toast"
  EventConnectionChanged SyncEventType = "connection-changed"
)

// SyncEvent åŒæ­¥äº‹ä»¶
type SyncEvent struct {
  Type      SyncEventType `json:"type"`
  Namespace string         `json:"namespace,omitempty"`
  SessionID string         `json:"sessionId,omitempty"`
  MachineID string        `json:"machineId,omitempty"`
  Data      interface{}   `json:"data,omitempty"`
  Message   *StoredMessage `json:"message,omitempty"`
}
```

```go
// internal/sync/event_publisher.go

package sync

const broadcastBufferSize = 1000  // èƒŒå‹ç¼“å†²

// EventPublisher äº‹ä»¶å‘å¸ƒå™¨ (å¸¦èƒŒå‹)
type EventPublisher struct {
  subscribers map[string]map[string]chan SyncEvent
  broadcast   chan SyncEvent
  mu          sync.RWMutex
}

func NewEventPublisher() *EventPublisher {
  p := &EventPublisher{
    subscribers: make(map[string]map[string]chan SyncEvent),
    broadcast:   make(chan SyncEvent, broadcastBufferSize),  // èƒŒå‹!
  }

  // å¯åŠ¨å¹¿æ’­ goroutine
  go p.broadcastLoop()
  return p
}

func (p *EventPublisher) broadcastLoop() {
  for event := range p.broadcast {
    p.mu.RLock()
    for _, subs := range p.subscribers {
      for _, ch := range subs {
        select {
        case ch <- event:  // éé˜»å¡å‘é€
        default:
          // ä»…å…è®¸ä¸¢å¼ƒä½ä¼˜å…ˆçº§äº‹ä»¶ï¼ˆå¦‚å¿ƒè·³ï¼‰
          // å…³é”®äº‹ä»¶éœ€é˜»å¡æˆ–æ‰©å®¹é˜Ÿåˆ—ï¼Œé¿å…è¯­ä¹‰å˜åŒ–
        }
      }
    }
    p.mu.RUnlock()
  }
}
```

---

### é˜¶æ®µä¸‰ï¼šé€šä¿¡å±‚ (Week 3)

**ç›®æ ‡**: å®ç° HTTPã€Socket.IOã€SSE æœåŠ¡å™¨

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æè¿° | çŠ¶æ€ | é¢„ä¼°å·¥æ—¶ |
|------|------|------|----------|
| 4.3.1 | å®ç° HTTP æœåŠ¡å™¨ä¸»ç»“æ„ | â³ | 2h |
| 4.3.2 | å®ç° JWT è®¤è¯ä¸­é—´ä»¶ | â³ | 4h |
| 4.3.3 | å®ç° /api/* è·¯ç”±ç»„ | â³ | 8h |
| 4.3.4 | å®ç° /cli/* è·¯ç”±ç»„ | â³ | 4h |
| 4.3.5 | å®ç° Socket.IO æœåŠ¡å™¨ï¼ˆEngine.IO æ¡æ‰‹å…¼å®¹ï¼‰ | â³ | 8h |
| 4.3.6 | å®ç° /cli å‘½åç©ºé—´å¤„ç†ï¼ˆäº‹ä»¶å/ACK å…¼å®¹ï¼‰ | â³ | 8h |
| 4.3.7 | å®ç° /terminal å‘½åç©ºé—´å¤„ç†ï¼ˆäº‹ä»¶å/ACK å…¼å®¹ï¼‰ | â³ | 8h |
| 4.3.8 | å®ç° SSE æœåŠ¡å™¨ | â³ | 4h |
| 4.3.9 | å®ç° SSE Manager (å¹¶è¡Œå¿ƒè·³) | â³ | 8h |
| 4.3.10 | å®ç° SSE è¿‡æ»¤æœºåˆ¶ | â³ | 4h |

#### é˜¶æ®µäº§å‡º

```
$ tree internal/http internal/socketio internal/sse
internal/http/
â”œâ”€â”€ server.go
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ auth.go
â””â”€â”€ handlers/
    â”œâ”€â”€ auth.go
    â”œâ”€â”€ sessions.go
    â”œâ”€â”€ messages.go
    â”œâ”€â”€ machines.go
    â”œâ”€â”€ permissions.go
    â””â”€â”€ git.go

internal/socketio/
â”œâ”€â”€ server.go
â”œâ”€â”€ cli_handler.go
â””â”€â”€ terminal_handler.go

internal/sse/
â”œâ”€â”€ server.go
â””â”€â”€ manager.go
```

#### å…³é”®æŠ€æœ¯ç‚¹

```go
// internal/socketio/server.go

package socketio

import (
  "net/http"
  "time"

  socketio "github.com/googollee/go-socket.io"
  "github.com/googollee/go-socket.io/engineio"
  "github.com/googollee/go-socket.io/engineio/transport"
  "github.com/googollee/go-socket.io/engineio/transport/polling"
  "github.com/googollee/go-socket.io/engineio/transport/websocket"
)

// Server Socket.IO æœåŠ¡å™¨ï¼ˆåè®®å…¼å®¹ï¼‰
type Server struct {
  io *socketio.Server
}

func NewServer() (*Server, error) {
  io, err := socketio.NewServer(&engineio.Options{
    Transports: []transport.Transport{
      &polling.Transport{},
      &websocket.Transport{
        CheckOrigin: func(r *http.Request) bool { return true },
      },
    },
    PingInterval: 25 * time.Second,
    PingTimeout:  60 * time.Second,
  })
  if err != nil {
    return nil, err
  }
  return &Server{io: io}, nil
}
```

```go
// internal/sse/manager.go

package sse

import (
  "context"
  "encoding/json"
  "sync"
  "time"
)

const (
  heartbeatInterval = 30 * time.Second
  heartbeatTimeout  = 10 * time.Second
)

// Manager SSE è¿æ¥ç®¡ç†å™¨
type Manager struct {
  connections map[string]*Connection
  register    chan *Connection
  unregister  chan string
  broadcast   chan Event
  mu          sync.RWMutex

  // å¹¶å‘å¿ƒè·³æ§åˆ¶
  heartbeatWg sync.WaitGroup
}

type Connection struct {
  ID         string
  Namespace  string
  SessionID  string
  MachineID  string
  All        bool
  Send       chan []byte
  CreatedAt  time.Time
}

func (m *Manager) Start() {
  // å¿ƒè·³ goroutine (å¹¶è¡Œ)
  go m.heartbeatLoop()
}

func (m *Manager) heartbeatLoop() {
  ticker := time.NewTicker(heartbeatInterval)
  defer ticker.Stop()

  for range ticker.C {
    m.mu.RLock()
    connections := make([]*Connection, 0, len(m.connections))
    for _, conn := range m.connections {
      connections = append(connections, conn)
    }
    m.mu.RUnlock()

    // å¹¶è¡Œå‘é€å¿ƒè·³
    m.heartbeatWg.Add(len(connections))
    for _, conn := range connections {
      go func(c *Connection) {
        defer m.heartbeatWg.Done()

        select {
        case c.Send <- []byte(": heartbeat\n\n"):
          // æˆåŠŸ
        default:
          // è¿æ¥æ»¡ï¼Œç§»é™¤
          m.unregister <- c.ID
        }
      }(conn)
    }

    m.heartbeatWg.Wait()  // ç­‰å¾…æ‰€æœ‰å¿ƒè·³å®Œæˆ
  }
}
```

---

### é˜¶æ®µå››ï¼šä¸šåŠ¡é€»è¾‘å±‚ (Week 4)

**ç›®æ ‡**: å®ç°æ‰€æœ‰ API ç«¯ç‚¹

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æè¿° | çŠ¶æ€ | é¢„ä¼°å·¥æ—¶ |
|------|------|------|----------|
| 4.4.1 | å®ç°è®¤è¯è·¯ç”± (/api/auth) | â³ | 4h |
| 4.4.2 | å®ç°ç»‘å®šè·¯ç”± (/api/bind) | â³ | 2h |
| 4.4.3 | å®ç°ä¼šè¯ CRUD | â³ | 8h |
| 4.4.4 | å®ç°ä¼šè¯æ¢å¤æœºåˆ¶ | â³ | 4h |
| 4.4.5 | å®ç°ä¼šè¯å½’æ¡£ | â³ | 2h |
| 4.4.6 | å®ç°æ¶ˆæ¯ API | â³ | 8h |
| 4.4.7 | å®ç°æ¶ˆæ¯åˆ†é¡µä¼˜åŒ– | â³ | 4h |
| 4.4.8 | å®ç°æœºå™¨ API | â³ | 4h |
| 4.4.9 | å®ç°æƒé™å®¡æ‰¹ | â³ | 4h |
| 4.4.10 | å®ç° Git æ“ä½œ API | â³ | 4h |

#### API ç«¯ç‚¹æ¸…å•

| æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|
| POST | `/api/auth` | ç”¨æˆ·è®¤è¯ |
| POST | `/api/bind` | è´¦å·ç»‘å®š |
| GET | `/api/sessions` | ä¼šè¯åˆ—è¡¨ |
| GET | `/api/sessions/:id` | ä¼šè¯è¯¦æƒ… |
| POST | `/api/sessions/:id/resume` | æ¢å¤ä¼šè¯ |
| POST | `/api/sessions/:id/abort` | ä¸­æ­¢ä¼šè¯ |
| POST | `/api/sessions/:id/archive` | å½’æ¡£ä¼šè¯ |
| GET | `/api/sessions/:id/messages` | æ¶ˆæ¯å†å² |
| POST | `/api/sessions/:id/messages` | å‘é€æ¶ˆæ¯ |
| GET | `/api/machines` | æœºå™¨åˆ—è¡¨ |
| POST | `/api/machines/:id/spawn` | ç”Ÿæˆä¼šè¯ |
| GET | `/api/events` | SSE äº‹ä»¶æµ |

---

### é˜¶æ®µäº”ï¼šé€šçŸ¥ç³»ç»Ÿ (Week 5)

**ç›®æ ‡**: å®ç°é€šçŸ¥ä¸­å¿ƒå’Œå¤šé€šé“æ¨é€

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æè¿° | çŠ¶æ€ | é¢„ä¼°å·¥æ—¶ |
|------|------|------|----------|
| 4.5.1 | å®ç° NotificationHub | â³ | 8h |
| 4.5.2 | å®ç° channel èƒŒå‹ | â³ | 4h |
| 4.5.3 | å®ç°å»é‡æœºåˆ¶ | â³ | 4h |
| 4.5.4 | å®ç° Web Push é€šé“ | â³ | 8h |
| 4.5.5 | å®ç° Telegram é€šé“ | â³ | 8h |
| 4.5.6 | å®ç°äº‹ä»¶è§£æå™¨ | â³ | 4h |

#### å…³é”®æŠ€æœ¯ç‚¹

```go
// internal/notifications/hub.go

package notifications

const (
  notificationBufferSize = 100
  dedupWindow            = 5 * time.Second
)

type Hub struct {
  channels      []NotificationChannel
  eventC        chan SyncEvent
  dedupMap      map[string]time.Time
  dedupMu       sync.RWMutex
  channelWg     sync.WaitGroup
}

func (h *Hub) Start(ctx context.Context) {
  for _, ch := range h.channels {
    h.channelWg.Add(1)
    go func(ch NotificationChannel) {
      defer h.channelWg.Done()
      ch.Start(ctx)
    }(ch)
  }

  go h.eventLoop(ctx)
}

func (h *Hub) eventLoop(ctx context.Context) {
  for {
    select {
    case event := <-h.eventC:
      h.handleEvent(event)
    case <-ctx.Done():
      return
    }
  }
}
```

---

### é˜¶æ®µå…­ï¼šTelegram Bot (Week 5-6)

**ç›®æ ‡**: å®ç° Telegram æœºå™¨äºº

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æè¿° | çŠ¶æ€ | é¢„ä¼°å·¥æ—¶ |
|------|------|------|----------|
| 4.6.1 | å®ç° Bot ä¸»é€»è¾‘ | â³ | 8h |
| 4.6.2 | å®ç°å‘½ä»¤å¤„ç† | â³ | 8h |
| 4.6.3 | å®ç°å›è°ƒå¤„ç† | â³ | 4h |
| 4.6.4 | å®ç°ä¼šè¯è§†å›¾ | â³ | 8h |
| 4.6.5 | å®ç°æ¶ˆæ¯æ¸²æŸ“ | â³ | 4h |
| 4.6.6 | å®ç°æƒé™å®¡æ‰¹äº¤äº’ | â³ | 4h |

---

### é˜¶æ®µä¸ƒï¼šéš§é“ç®¡ç†ä¸æµ‹è¯• (Week 7)

**ç›®æ ‡**: å®Œæˆéš§é“ç®¡ç†å’Œå…¨é¢æµ‹è¯•

#### ä»»åŠ¡æ¸…å•

| ä»»åŠ¡ | æè¿° | çŠ¶æ€ | é¢„ä¼°å·¥æ—¶ |
|------|------|------|----------|
| 4.7.1 | å®ç° TunnelManager | â³ | 8h |
| 4.7.2 | å®ç° TLS å°±ç»ªæ£€æŸ¥ | â³ | 4h |
| 4.7.3 | å®ç°å­è¿›ç¨‹ç®¡ç† | â³ | 4h |
| 4.7.4 | ç¼–å†™å•å…ƒæµ‹è¯• (>80% è¦†ç›–) | â³ | 16h |
| 4.7.5 | ç¼–å†™é›†æˆæµ‹è¯• | â³ | 8h |
| 4.7.6 | è´Ÿè½½æµ‹è¯• (k6/wrk) | â³ | 8h |
| 4.7.7 | æ€§èƒ½è°ƒä¼˜ | â³ | 8h |
| 4.7.8 | å…¼å®¹æ€§æµ‹è¯• | â³ | 8h |
| 4.7.9 | æ–‡æ¡£ç¼–å†™ | â³ | 8h |

---

## 5. æŠ€æœ¯å†³ç­–

### 5.1 é€šä¿¡åè®®

| å†³ç­– | é€‰æ‹© | ç†ç”± |
|------|------|------|
| HTTP è·¯ç”± | gorilla/mux | æˆç†Ÿç¨³å®šï¼Œä¸­é—´ä»¶ä¸°å¯Œ |
| WebSocket | Socket.IO å…¼å®¹åº“ï¼ˆGoï¼‰ | ä¿æŒ CLI/Web å®Œå…¨å…¼å®¹ |
| SSE | åŸç”Ÿå®ç° | Go æ ‡å‡†åº“è¶³å¤Ÿ |
| æ¶ˆæ¯ç¼–ç  | JSON | ä¸ç°æœ‰å®¢æˆ·ç«¯ä¸€è‡´ |
| äºŒè¿›åˆ¶å¸§ | ä¸ä½¿ç”¨ | ç¦æ­¢åè®®å˜æ›´ |

### 5.2 å¹¶å‘æ¨¡å‹

```go
// Go å¹¶å‘æ¨¡å¼

// 1. Worker Pool (SSE å¿ƒè·³)
for i := 0; i < numWorkers; i++ {
  go worker(heartbeatQueue)
}

// 2. Channel èƒŒå‹
broadcast := make(chan SyncEvent, 1000)  // èƒŒå‹ç¼“å†²

// 3. WaitGroup å¹¶å‘æ§åˆ¶
var wg sync.WaitGroup
for _, conn := range connections {
  wg.Add(1)
  go func(c *Connection) {
    defer wg.Done()
    sendHeartbeat(c)
  }(conn)
}
wg.Wait()
```

### 5.3 æ•°æ®åº“ä¼˜åŒ–

| ä¼˜åŒ– | å®ç° |
|------|------|
| è¿æ¥æ±  | `sql.Open` + `SetMaxOpenConns(10)` |
| WAL æ¨¡å¼ | `PRAGMA journal_mode=WAL` |
| æ‰¹é‡æŸ¥è¯¢ | `WHERE id IN (?,?,...)` |
| ç´¢å¼• | å…³é”®å­—æ®µå»ºç«‹ç´¢å¼• |

### 5.4 å†…å­˜ä¼˜åŒ–

```go
// sync.Pool å¤ç”¨å¯¹è±¡
var messagePool = sync.Pool{
  New: func() interface{} {
    return new(SyncEvent)
  },
}

// ä½¿ç”¨
msg := messagePool.Get().(*SyncEvent)
defer messagePool.Put(msg)
```

---

## 6. æ–‡ä»¶ç»“æ„

```
hub_go/
â”œâ”€â”€ cmd/
â”‚   â””â”€â”€ server/
â”‚       â””â”€â”€ main.go                    # å…¥å£
â”‚
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ config.go                 # é…ç½®åŠ è½½
â”‚   â”‚   â”œâ”€â”€ settings.go               # settings.json
â”‚   â”‚   â”œâ”€â”€ jwt.go                    # JWT å¯†é’¥
â”‚   â”‚   â”œâ”€â”€ cli_token.go              # CLI Token
â”‚   â”‚   â””â”€â”€ vapid.go                  # VAPID å¯†é’¥
â”‚   â”‚
â”‚   â”œâ”€â”€ store/
â”‚   â”‚   â”œâ”€â”€ db.go                     # æ•°æ®åº“è¿æ¥
â”‚   â”‚   â”œâ”€â”€ sessions.go               # ä¼šè¯å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ machines.go              # æœºå™¨å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ messages.go              # æ¶ˆæ¯å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ users.go                 # ç”¨æˆ·å­˜å‚¨
â”‚   â”‚   â””â”€â”€ push.go                  # æ¨é€å­˜å‚¨
â”‚   â”‚
â”‚   â”œâ”€â”€ sync/
â”‚   â”‚   â”œâ”€â”€ engine.go                # åŒæ­¥å¼•æ“
â”‚   â”‚   â”œâ”€â”€ session_cache.go          # ä¼šè¯ç¼“å­˜
â”‚   â”‚   â”œâ”€â”€ machine_cache.go          # æœºå™¨ç¼“å­˜
â”‚   â”‚   â”œâ”€â”€ message_service.go        # æ¶ˆæ¯æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ rpc_gateway.go            # RPC ç½‘å…³
â”‚   â”‚   â””â”€â”€ event.go                  # äº‹ä»¶ç±»å‹
â”‚   â”‚
â”‚   â”œâ”€â”€ http/
â”‚   â”‚   â”œâ”€â”€ server.go                 # HTTP æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ middleware/
â”‚   â”‚   â”‚   â””â”€â”€ auth.go               # JWT è®¤è¯
â”‚   â”‚   â””â”€â”€ handlers/
â”‚   â”‚       â”œâ”€â”€ auth.go               # è®¤è¯å¤„ç†
â”‚   â”‚       â”œâ”€â”€ sessions.go           # ä¼šè¯å¤„ç†
â”‚   â”‚       â”œâ”€â”€ messages.go           # æ¶ˆæ¯å¤„ç†
â”‚   â”‚       â”œâ”€â”€ machines.go           # æœºå™¨å¤„ç†
â”‚   â”‚       â”œâ”€â”€ permissions.go        # æƒé™å¤„ç†
â”‚   â”‚       â””â”€â”€ git.go                # Git å¤„ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ socketio/
â”‚   â”‚   â”œâ”€â”€ server.go                 # Socket.IO æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ cli_handler.go            # CLI å‘½åç©ºé—´
â”‚   â”‚   â””â”€â”€ terminal_handler.go       # ç»ˆç«¯å‘½åç©ºé—´
â”‚   â”‚
â”‚   â”œâ”€â”€ sse/
â”‚   â”‚   â”œâ”€â”€ server.go                 # SSE æœåŠ¡å™¨
â”‚   â”‚   â””â”€â”€ manager.go                # è¿æ¥ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ notifications/
â”‚   â”‚   â”œâ”€â”€ hub.go                    # é€šçŸ¥ä¸­å¿ƒ
â”‚   â”‚   â”œâ”€â”€ push.go                   # Web Push
â”‚   â”‚   â””â”€â”€ telegram.go               # Telegram
â”‚   â”‚
â”‚   â”œâ”€â”€ telegram/
â”‚   â”‚   â”œâ”€â”€ bot.go                    # Bot ä¸»é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ handlers.go               # å‘½ä»¤å¤„ç†
â”‚   â”‚   â”œâ”€â”€ callbacks.go              # å›è°ƒå¤„ç†
â”‚   â”‚   â””â”€â”€ session_view.go           # ä¼šè¯è§†å›¾
â”‚   â”‚
â”‚   â”œâ”€â”€ tunnel/
â”‚   â”‚   â””â”€â”€ manager.go                # éš§é“ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ visibility/
â”‚       â””â”€â”€ tracker.go                # å¯è§æ€§è¿½è¸ª
â”‚
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ crypto/
â”‚   â”‚   â””â”€â”€ constant_time.go          # å¸¸æ•°æ—¶é—´æ¯”è¾ƒ
â”‚   â”œâ”€â”€ encoding/
â”‚   â”‚   â””â”€â”€ json.go                  # JSON ç¼–ç /è§£ç 
â”‚   â””â”€â”€ types/
â”‚       â””â”€â”€ sync_event.go            # äº‹ä»¶ç±»å‹
â”‚
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ V3__initial.sql              # æ•°æ®åº“è¿ç§»
â”‚
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ compatibility/               # å…¼å®¹æ€§æµ‹è¯•
â”‚   â”œâ”€â”€ integration/                 # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ contracts/                   # å¥‘çº¦æµ‹è¯•
â”‚
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build.sh                     # æ„å»ºè„šæœ¬
â”‚   â””â”€â”€ test-compatibility.sh        # å…¼å®¹æ€§æµ‹è¯•
â”‚
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ Makefile
â””â”€â”€ README.md
```

---

## 7. ä¾èµ–æ¸…å•

```toml
# go.mod

module github.com/tiann/hapi-hub_go

go 1.21

require (
  github.com/gorilla/mux v1.8.1          # HTTP è·¯ç”±
  github.com/googollee/go-socket.io v1.7.0 # Socket.IO å…¼å®¹
  github.com/mattn/go-sqlite3 v1.14.22   # SQLite
  github.com/golang-jwt/jwt/v5 v5.2.1     # JWT
  github.com/google/uuid v1.6.0          # UUID
  github.com/telegram-bot-api/v5 v5.1.0  # Telegram Bot
  github.com/web-push-go/web-push v1.3.2 # Web Push
  github.com/juju/ratelimit v1.0.2       # é€Ÿç‡é™åˆ¶
  github.com/stretchr/testify v1.9.0     # æµ‹è¯•
  github.com/valyala/fasthttp v1.52.0    # HTTP å®¢æˆ·ç«¯
)
```

---

## 8. é‡Œç¨‹ç¢‘

| é˜¶æ®µ | é‡Œç¨‹ç¢‘ | éªŒæ”¶æ ‡å‡† | é¢„ä¼°æ—¶é—´ |
|------|--------|---------|----------|
| M1 | é¡¹ç›®åˆå§‹åŒ– | Go mod åˆ›å»ºï¼ŒDB è¿æ¥æˆåŠŸ | Week 1, Day 1 |
| M2 | æ•°æ®åº“å°±ç»ª | CRUD æµ‹è¯•é€šè¿‡ | Week 1, Day 5 |
| M3 | åŒæ­¥å¼•æ“å®Œæˆ | ç¼“å­˜å’Œäº‹ä»¶ç³»ç»Ÿå·¥ä½œ | Week 2, Day 5 |
| M4 | é€šä¿¡å±‚å®Œæˆ | WS å’Œ SSE è¿æ¥æ­£å¸¸ | Week 3, Day 5 |
| M5 | API å®Œæ•´ | æ‰€æœ‰ API ç«¯ç‚¹å¯ç”¨ | Week 4, Day 5 |
| M6 | é€šçŸ¥ç³»ç»Ÿå®Œæˆ | Push å’Œ Telegram å·¥ä½œ | Week 5, Day 5 |
| M7 | Bot å®Œæˆ | æœºå™¨äººåŠŸèƒ½å®Œæ•´ | Week 6, Day 3 |
| M8 | æµ‹è¯•å®Œæˆ | >80% è¦†ç›–ï¼Œå…¼å®¹æ€§é€šè¿‡ | Week 7, Day 5 |
| **Total** | **ç”Ÿäº§å°±ç»ª** | **å®Œæ•´åŠŸèƒ½** | **7 å‘¨** |

### ç”˜ç‰¹å›¾

```
Week    1    2    3    4    5    6    7
       â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
åŸºç¡€è®¾æ–½ â”‚â–ˆâ–ˆâ–ˆâ–ˆâ”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
       â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
åŒæ­¥å¼•æ“ â”‚    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ”‚    â”‚    â”‚    â”‚    â”‚    â”‚
       â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
é€šä¿¡å±‚   â”‚    â”‚    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ”‚    â”‚    â”‚    â”‚    â”‚
       â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
ä¸šåŠ¡é€»è¾‘ â”‚    â”‚    â”‚    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ”‚    â”‚    â”‚    â”‚
       â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
é€šçŸ¥ç³»ç»Ÿ â”‚    â”‚    â”‚    â”‚    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ”‚    â”‚    â”‚
       â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
Bot     â”‚    â”‚    â”‚    â”‚    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ”‚â–ˆâ–ˆâ–ˆâ–ˆâ”‚    â”‚
       â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
æµ‹è¯•ä¼˜åŒ– â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ”‚
       â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜
```

---

## 9. é£é™©ä¸ç¼“è§£

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|-------|------|----------|
| CLI å…¼å®¹æ€§é—®é¢˜ | ä¸­ | é«˜ | ä¿æŒ Socket.IO åè®®å…¼å®¹ï¼Œæä¾›é€‚é…å±‚ |
| Socket.IO åè®®å®ç°ä¸ä¸€è‡´ | ä¸­ | é«˜ | ç«¯åˆ°ç«¯å¥‘çº¦+å›å½’æµ‹è¯•ï¼Œä¼˜å…ˆå¤ç”¨ç°æœ‰åè®®è¡Œä¸º |
| æ•°æ®åº“è¿ç§»å¤±è´¥ | ä½ | é«˜ | å›æ»šè„šæœ¬ï¼Œæµ‹è¯•ç¯å¢ƒéªŒè¯ |
| Telegram API å˜æ›´ | ä½ | ä¸­ | ä½¿ç”¨ç¨³å®šç‰ˆæœ¬åº“ |
| æ€§èƒ½æœªè¾¾é¢„æœŸ | ä¸­ | ä¸­ | æå‰è´Ÿè½½æµ‹è¯•ï¼Œæ€§èƒ½åˆ†æ |
| èµ„æºå ç”¨è¿‡é«˜ | ä¸­ | ä¸­ | è¿æ¥æ± è°ƒä¼˜ï¼Œå†…å­˜æ± åŒ– |
| å®‰å…¨æ€§é—®é¢˜ | ä½ | é«˜ | å®‰å…¨å®¡è®¡ï¼Œæ¸—é€æµ‹è¯• |

---

## 10. å…¼å®¹æ€§ä¿éšœ

è¯¦è§ [HUB_COMPATIBILITY_PLAN.md](./HUB_COMPATIBILITY_PLAN.md)

### æ ¸å¿ƒç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å…¼å®¹æ€§ä¿éšœä½“ç³»                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. å¥‘çº¦å®šä¹‰                                                     â”‚
â”‚     â”œâ”€â”€ HTTP API å¥‘çº¦ (è·¯å¾„ã€æ–¹æ³•ã€è¯·æ±‚/å“åº”æ ¼å¼)                â”‚
â”‚     â”œâ”€â”€ Socket.IO äº‹ä»¶å¥‘çº¦                                      â”‚
â”‚     â””â”€â”€ SSE äº‹ä»¶å¥‘çº¦                                            â”‚
â”‚                                                                 â”‚
â”‚  2. å¹¶è¡Œè¿è¡ŒéªŒè¯                                                 â”‚
â”‚     â”œâ”€â”€ åŒæ—¶å¯åŠ¨ Bun Hub å’Œ Go Hub                              â”‚
â”‚     â”œâ”€â”€ æµé‡é•œåƒåˆ°ä¸¤ä¸ªæœåŠ¡å™¨                                     â”‚
â”‚     â””â”€â”€ å¯¹æ¯”å“åº”çŠ¶æ€ç ã€å“åº”ä½“ã€å»¶è¿Ÿå·®å¼‚                        â”‚
â”‚                                                                 â”‚
â”‚  3. è‡ªåŠ¨åŒ–æµ‹è¯•                                                   â”‚
â”‚     â”œâ”€â”€ HTTP å…¼å®¹æ€§æµ‹è¯•                                         â”‚
â”‚     â”œâ”€â”€ Socket.IO äº‹ä»¶å…¼å®¹æ€§æµ‹è¯•                                â”‚
â”‚     â””â”€â”€ æ•°æ®å®Œæ•´æ€§æµ‹è¯•                                          â”‚
â”‚                                                                 â”‚
â”‚  4. CI/CD é›†æˆ                                                   â”‚
â”‚     â””â”€â”€ æ¯æ¬¡ PR è‡ªåŠ¨è¿è¡Œå…¼å®¹æ€§æµ‹è¯•                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å…¼å®¹æ€§æ£€æŸ¥æ¸…å•

- [ ] API è·¯å¾„å’Œæ–¹æ³•ä¿æŒä¸€è‡´
- [ ] è¯·æ±‚/å“åº” JSON ç»“æ„å…¼å®¹
- [ ] Socket.IO äº‹ä»¶åç§°ä¸å˜
- [ ] Engine.IO æ¡æ‰‹å‚æ•°ä¸ ping/pong è¯­ä¹‰ä¸€è‡´
- [ ] ACK å›è°ƒå‚æ•°ä¸é¡ºåºä¸€è‡´
- [ ] SSE äº‹ä»¶ç±»å‹ä¸å˜
- [ ] JWT Token æ ¼å¼å…¼å®¹
- [ ] æ•°æ®åº“ schema å…¼å®¹ï¼ˆä»…å‘å‰å…¼å®¹è¿ç§»ï¼‰

---

## 11. æ€§èƒ½ç›®æ ‡

### 11.1 åŸºå‡†æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰ (Bun) | ç›®æ ‡ (Go) | æå‡ |
|------|-----------|----------|------|
| SSE å¿ƒè·³å»¶è¿Ÿ | <10ms | <1ms | 10x |
| å¹¿æ’­ååé‡ | 1K events/s | 10K events/s | 10x |
| å†…å­˜ä½¿ç”¨ | ~200MB | ~100MB | 2x |
| å¹¶å‘è¿æ¥æ•° | 1,000 | 10,000 | 10x |
| API å“åº”æ—¶é—´ P99 | <100ms | <50ms | 2x |

### 11.2 è´Ÿè½½æµ‹è¯•

```go
// test/load/load_test.go

func TestSSEHeartbeat(t *testing.T) {
  // æµ‹è¯• 10000 å¹¶å‘ SSE è¿æ¥
  // éªŒè¯å¿ƒè·³å‘é€å»¶è¿Ÿ
  // éªŒè¯å†…å­˜ä½¿ç”¨
}

func TestBroadcast(t *testing.T) {
  // æµ‹è¯• 1000 events/s å¹¿æ’­
  // éªŒè¯èƒŒå‹æœºåˆ¶
  // éªŒè¯æ— ä¸¢åŒ…
}
```

---

## 12. è¿ç§»æ­¥éª¤ä¸åˆ‡æ¢æµç¨‹

### 12.1 è¿ç§»æ­¥éª¤ï¼ˆå¼ºåˆ¶é¡ºåºï¼‰

1. **å†»ç»“å¥‘çº¦**ï¼šä»¥ `HUB_CONTRACT_BASELINE.md` ä¸ `hub_go/test/contracts/*` ä¸ºå”¯ä¸€çœŸæºã€‚
2. **Go Hub åªè¯»è¿è¡Œ**ï¼šGo Hub ä»…è®¢é˜…/è¯»å–ï¼Œä¸å†™ DBï¼Œä¸å‘å˜æ›´äº‹ä»¶ã€‚
3. **HTTP å…¼å®¹**ï¼šæ‰€æœ‰ `/api` ä¸ `/cli` ç«¯ç‚¹å“åº”ç»“æ„ä¸çŠ¶æ€ç å¯¹é½ã€‚
4. **Socket.IO å…¼å®¹**ï¼šåè®®æ¡æ‰‹ã€äº‹ä»¶åã€ACK é¡ºåºã€æ–­çº¿é‡è¿è¯­ä¹‰å¯¹é½ã€‚
5. **SSE å…¼å®¹**ï¼šäº‹ä»¶ç±»å‹ã€å­—æ®µã€å¿ƒè·³ã€è¿æ¥å»ºç«‹äº‹ä»¶å®Œå…¨ä¸€è‡´ã€‚
6. **å¹¶è¡Œé•œåƒ**ï¼šé•œåƒæµé‡åˆ° Go Hubï¼Œå¯¹æ¯”å·®å¼‚ï¼ˆä»…è®°å½•ï¼Œä¸å›å†™ï¼‰ã€‚
7. **ç°åº¦å†™å…¥**ï¼šå°æµé‡åˆ‡æ¢ä¸º Go Hub å†™å…¥ï¼ŒBun Hub åªè¯»ã€‚
8. **å…¨é‡åˆ‡æ¢**ï¼šGo Hub æˆä¸ºå”¯ä¸€å†™å…¥ä¸å¯¹å¤–æœåŠ¡ç«¯ã€‚

### 12.2 åˆ‡æ¢æµç¨‹ï¼ˆè¿è¡Œæ‰‹å†Œï¼‰

**å‡†å¤‡**
- å…³é—­æ‰€æœ‰ schema ç ´åæ€§è¿ç§»ã€‚
- ç¡®è®¤åˆåŒæµ‹è¯•é€šè¿‡ï¼ˆHTTP/Socket/SSEï¼‰ã€‚
- æ˜ç¡®å•å†™ä¸»ç­–ç•¥ï¼ˆBun å†™ or Go å†™ï¼‰ã€‚

**åˆ‡æ¢**
1. å¯åŠ¨ Go Hubï¼ˆåªè¯»æ¨¡å¼ï¼‰å¹¶è¿æ¥åŒä¸€ DBã€‚
2. å¼€å¯æµé‡é•œåƒï¼Œå¯¹æ¯” 24h æŒ‡æ ‡ã€‚
3. è‹¥å·®å¼‚ < é˜ˆå€¼ï¼Œåˆ‡ Go Hub ä¸ºå†™å…¥ï¼ŒBun Hub åªè¯»ã€‚
4. æŒç»­è§‚å¯Ÿ 24hï¼Œæ— å¼‚å¸¸ååˆ‡æ¢å…¥å£æµé‡åˆ° Go Hubã€‚

**å›æ»š**
- ç«‹å³åˆ‡å› Bun Hub å†™å…¥å¹¶æ¢å¤å…¥å£æµé‡ã€‚
- ä¿ç•™ Go Hub åªè¯»ç”¨äºå¤ç°é—®é¢˜ã€‚

## é™„å½•

### A. å¯åŠ¨å‘½ä»¤

```bash
# å¼€å‘æ¨¡å¼
make dev

# æ„å»º
make build

# æµ‹è¯•
make test

# å…¼å®¹æ€§æµ‹è¯•
make test-compatibility

# è¿è¡Œ
./bin/hub_go --port 3007
```

### B. ç¯å¢ƒå˜é‡

| å˜é‡ | é»˜è®¤å€¼ | æè¿° |
|------|--------|------|
| `HAPI_HOME` | `~/.hapi` | æ•°æ®ç›®å½• |
| `DB_PATH` | `{HAPI_HOME}/hapi.db` | æ•°æ®åº“è·¯å¾„ |
| `HAPI_LISTEN_HOST` | `127.0.0.1` | ç›‘å¬åœ°å€ |
| `HAPI_LISTEN_PORT` | `3007` | ç›‘å¬ç«¯å£ |
| `TELEGRAM_BOT_TOKEN` | - | Telegram Bot Token |

### C. ç›¸å…³æ–‡æ¡£

- [æ€§èƒ½ç“¶é¢ˆåˆ†æ](./PERFORMANCE_ANALYSIS.md)
- [å…¼å®¹æ€§ä¿éšœè®¡åˆ’](./HUB_COMPATIBILITY_PLAN.md)
- [API å¥‘çº¦æ–‡æ¡£](../api/)
